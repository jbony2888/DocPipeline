{% extends "base.html" %}

{% block title %}Job Status - IFI Essay Gateway{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <h2>Job Status</h2>
            <hr>
            
            <div id="job-details" class="card">
                <div class="card-body">
                    <h5 class="card-title">Job ID: <code>{{ job_id }}</code></h5>
                    
                    <div id="status-container" class="mt-3">
                        <div class="alert alert-info" role="alert">
                            <strong>Status:</strong> <span id="status-text">Loading...</span>
                        </div>
                        
                        <div id="job-info" class="mt-3">
                            <p><strong>Created:</strong> <span id="created-at">-</span></p>
                            <p><strong>Started:</strong> <span id="started-at">-</span></p>
                            <p><strong>Finished:</strong> <span id="finished-at">-</span></p>
                            <p><strong>Filename:</strong> <span id="filename">-</span></p>
                            <p id="error-message" class="text-danger" style="display: none;"><strong>Error:</strong> <span id="error-text"></span></p>
                        </div>
                        
                        <div id="result-link" class="mt-3" style="display: none;">
                            <a href="{{ url_for('review', mode='needs_review') }}" class="btn btn-primary">View in Review Page</a>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button onclick="location.reload()" class="btn btn-secondary">Refresh</button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-link">Back to Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const jobId = '{{ job_id }}';
    let pollInterval = null;
    
    function updateJobStatus() {
        fetch(`/api/job_status/${jobId}`)
            .then(r => r.json())
            .then(data => {
                const status = data.status || 'unknown';
                const statusText = document.getElementById('status-text');
                const statusContainer = document.getElementById('status-container').querySelector('.alert');
                
                // Update status display
                statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                
                // Update status colors
                statusContainer.className = 'alert';
                if (status === 'finished' || status === 'completed') {
                    statusContainer.classList.add('alert-success');
                } else if (status === 'failed' || status === 'error') {
                    statusContainer.classList.add('alert-danger');
                } else if (status === 'started' || status === 'processing') {
                    statusContainer.classList.add('alert-warning');
                } else {
                    statusContainer.classList.add('alert-info');
                }
                
                // Update timestamps
                if (data.created_at) {
                    document.getElementById('created-at').textContent = new Date(data.created_at).toLocaleString();
                }
                if (data.started_at) {
                    document.getElementById('started-at').textContent = new Date(data.started_at).toLocaleString();
                }
                if (data.finished_at) {
                    document.getElementById('finished-at').textContent = new Date(data.finished_at).toLocaleString();
                }
                
                // Update filename from result or error
                if (data.result && data.result.filename) {
                    document.getElementById('filename').textContent = data.result.filename;
                } else if (data.filename) {
                    document.getElementById('filename').textContent = data.filename;
                }
                
                // Show error if failed
                if (status === 'failed' || status === 'error') {
                    const errorMsg = document.getElementById('error-message');
                    const errorText = document.getElementById('error-text');
                    errorMsg.style.display = 'block';
                    errorText.textContent = data.error || data.error_message || 'Unknown error';
                }
                
                // Show result link if completed
                if (status === 'finished' || status === 'completed') {
                    document.getElementById('result-link').style.display = 'block';
                    
                    // Stop polling
                    if (pollInterval) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                } else {
                    // Continue polling if not finished
                    if (!pollInterval) {
                        pollInterval = setInterval(updateJobStatus, 2000);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching job status:', error);
                document.getElementById('status-text').textContent = 'Error loading status';
                document.getElementById('status-container').querySelector('.alert').className = 'alert alert-danger';
            });
    }
    
    // Initial load
    updateJobStatus();
    
    // Poll every 2 seconds if job is not finished
    pollInterval = setInterval(updateJobStatus, 2000);
</script>
{% endblock %}

