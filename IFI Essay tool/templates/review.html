{% extends "base.html" %}

{% block title %}Review & Approval - IFI Essay Gateway{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="h2">4Ô∏è‚É£ Review & Approval Workflow</h1>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="h2" id="dbStatsTotal">{{ db_stats.total_count }}</h3>
                <p class="text-muted mb-0">üìä Total Records</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="h2 text-success" id="dbStatsClean">{{ db_stats.clean_count }}</h3>
                <p class="text-muted mb-0">‚úÖ Clean Records</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="h2 text-warning" id="dbStatsNeedsReview">{{ db_stats.needs_review_count }}</h3>
                <p class="text-muted mb-0">‚ö†Ô∏è Needs Review</p>
            </div>
        </div>
    </div>
</div>

{% if batch_info and upload_batch_id and review_mode == 'needs_review' %}
<div class="card mb-3 border-primary">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-sliders"></i> Batch Defaults</h5>
    </div>
    <div class="card-body">
        <p class="text-muted">Set default values for all submissions in this batch. These will only fill empty fields and won't overwrite manual edits.</p>
        <form id="batchDefaultsForm">
            <div class="row">
                <div class="col-md-4">
                    <label for="default_school_name" class="form-label">Default School Name</label>
                    <input type="text" class="form-control" id="default_school_name" 
                           value="{{ batch_info.default_school_name or '' }}" 
                           placeholder="e.g., Lincoln Elementary">
                </div>
                <div class="col-md-4">
                    <label for="default_grade" class="form-label">Default Grade</label>
                    <input type="text" class="form-control" id="default_grade" 
                           value="{{ batch_info.default_grade or '' }}" 
                           placeholder="e.g., 5, K, or Kindergarten">
                </div>
                <div class="col-md-4">
                    <label for="default_teacher_name" class="form-label">Default Teacher Name (Optional)</label>
                    <input type="text" class="form-control" id="default_teacher_name" 
                           value="{{ batch_info.default_teacher_name or '' }}" 
                           placeholder="e.g., Mrs. Smith">
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Apply Defaults to Batch
                </button>
                <span id="batchDefaultsStatus" class="ms-3"></span>
            </div>
        </form>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <div class="btn-group" role="group">
            <a href="{{ url_for('review', mode='needs_review') }}" 
               class="btn btn-{{ 'primary' if review_mode == 'needs_review' else 'outline-primary' }}">
                <i class="bi bi-exclamation-triangle"></i> Needs Review
            </a>
            <a href="{{ url_for('review', mode='approved') }}" 
               class="btn btn-{{ 'primary' if review_mode == 'approved' else 'outline-primary' }}">
                <i class="bi bi-check-circle"></i> Approved Records
            </a>
        </div>
        {% if review_mode == 'approved' and records %}
        <div class="float-end">
            <a href="{{ url_for('export_csv') }}" class="btn btn-success">
                <i class="bi bi-download"></i> Export All to CSV
            </a>
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        {% if review_mode == 'needs_review' %}
            {# Needs Review Section - show flat list #}
            {% if records %}
            <p class="text-muted">Found <strong>{{ records|length }}</strong> record(s) needing review</p>
            
            {# Bulk Edit / Bulk Delete Panel - ALWAYS SHOWN when there are records #}
            <div class="card mb-4 border-info shadow-sm" style="border-width: 2px !important;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Bulk Edit &amp; Delete Selected Records</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-2">Select records below with the checkboxes. Then either: set School Name or Grade and click <strong>Apply to Selected</strong>, or click <strong>Delete Selected</strong> to remove them permanently.</p>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bulk_school_name" class="form-label">School Name</label>
                            <input type="text" class="form-control" id="bulk_school_name" 
                                   placeholder="e.g., Lincoln Elementary">
                        </div>
                        <div class="col-md-6">
                            <label for="bulk_grade" class="form-label">Grade</label>
                            <input type="text" class="form-control" id="bulk_grade" 
                                   placeholder="e.g., 5, K, or Kindergarten">
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 align-items-center" id="bulkActionsRow">
                        <button type="button" class="btn btn-primary bulk-action-btn" onclick="applyBulkEdit()">
                            <i class="bi bi-check-circle"></i> Apply to Selected (<span id="selectedCount">0</span>)
                        </button>
                        <button type="button" class="btn btn-outline-secondary bulk-action-btn" onclick="selectAllRecords()">
                            <i class="bi bi-check-all"></i> Select All
                        </button>
                        <button type="button" class="btn btn-outline-secondary bulk-action-btn" onclick="deselectAllRecords()">
                            <i class="bi bi-x-square"></i> Deselect All
                        </button>
                        <button type="button" class="btn btn-danger bulk-action-btn" id="bulkDeleteBtn" onclick="bulkDeleteSelected()">
                            <i class="bi bi-trash"></i> Delete Selected
                        </button>
                        <span id="bulkEditStatus" class="ms-3"></span>
                    </div>
                    <div id="bulkDeleteLoader" class="mt-2 text-center py-3" style="display: none;">
                        <div class="spinner-border text-danger" role="status"><span class="visually-hidden">Loading...</span></div>
                        <p class="mb-0 mt-2 text-muted">Deleting selected records‚Ä¶ please wait.</p>
                    </div>
                </div>
            </div>
            
            <div class="accordion" id="recordsAccordion">
                {% for record in records %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ loop.index }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapse{{ loop.index }}">
                        <div class="form-check me-3">
                            <input class="form-check-input record-checkbox" type="checkbox" 
                                   value="{{ record.submission_id }}" 
                                   id="checkbox{{ loop.index }}"
                                   onchange="updateSelectedCount()"
                                   onclick="event.stopPropagation();">
                        </div>
                        {% if review_mode == 'needs_review' %}‚ö†Ô∏è{% else %}‚úÖ{% endif %}
                        {{ record.submission_id }} - {{ record.student_name or 'Unknown' }}
                    </button>
                </h2>
                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" 
                     data-bs-parent="#recordsAccordion">
                    <div class="accordion-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Contact Information</h6>
                                <p class="mb-1"><strong>Student:</strong> {{ record.student_name or 'N/A' }}</p>
                                <p class="mb-1"><strong>School:</strong> {{ record.school_name or 'N/A' }}</p>
                                <p class="mb-1"><strong>Grade:</strong> {{ record.grade or 'N/A' }}</p>
                                {% if record.teacher_name %}
                                <p class="mb-1"><strong>Teacher:</strong> {{ record.teacher_name }}</p>
                                {% endif %}
                                {% if record.city_or_location %}
                                <p class="mb-1"><strong>Location:</strong> {{ record.city_or_location }}</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6>Additional Info</h6>
                                {% if record.father_figure_name %}
                                <p class="mb-1"><strong>Father Figure:</strong> {{ record.father_figure_name }}</p>
                                {% endif %}
                                {% if record.phone %}
                                <p class="mb-1"><strong>Phone:</strong> {{ record.phone }}</p>
                                {% endif %}
                                {% if record.email %}
                                <p class="mb-1"><strong>Email:</strong> {{ record.email }}</p>
                                {% endif %}
                                <p class="mb-1"><strong>Word Count:</strong> {{ record.word_count or 0 }}</p>
                                {% if record.review_reason_codes %}
                                <p class="mb-1 text-danger">
                                    <strong>‚ö†Ô∏è Review Reasons:</strong> {{ format_review_reasons(record.review_reason_codes) }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        <hr>
                        {% set pdf_path = get_pdf_path(record.get('artifact_dir', '')) %}
                        {% if pdf_path %}
                        <div class="mb-3">
                            <a href="{{ url_for('serve_pdf', file_path=pdf_path) }}" 
                               target="_blank" 
                               class="btn btn-sm btn-outline-info">
                                <i class="bi bi-file-pdf"></i> View PDF (New Tab)
                            </a>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="togglePdfView('{{ record.submission_id }}', '{{ url_for('serve_pdf', file_path=pdf_path) }}')">
                                <i class="bi bi-arrows-angle-expand"></i> View Side-by-Side
                            </button>
                        </div>
                        {% endif %}
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('record_detail', submission_id=record.submission_id) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            {% if review_mode == 'needs_review' %}
                            <button class="btn btn-sm btn-success" onclick="approveRecord('{{ record.submission_id }}')">
                                <i class="bi bi-check-circle"></i> Approve
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="reprocessRecord('{{ record.submission_id }}')">
                                <i class="bi bi-arrow-repeat"></i> Reprocess
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-warning" onclick="sendForReview('{{ record.submission_id }}')">
                                <i class="bi bi-exclamation-triangle"></i> Send for Review
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-danger" onclick="deleteRecord('{{ record.submission_id }}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                        {% if pdf_path %}
                        <div id="pdf-viewer-{{ record.submission_id }}" class="mt-3" style="display: none;">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-white">
                                        <i class="bi bi-file-pdf"></i> PDF Viewer: {{ record.submission_id }}
                                    </h6>
                                    <button class="btn btn-sm btn-light" onclick="togglePdfView('{{ record.submission_id }}', null)">
                                        <i class="bi bi-x"></i> Close
                                    </button>
                                </div>
                                <div class="card-body p-0" style="height: 600px; overflow: hidden;">
                                    <iframe id="iframe-{{ record.submission_id }}" 
                                            src="{{ url_for('serve_pdf', file_path=pdf_path) }}" 
                                            style="width: 100%; height: 100%; border: none;"
                                            allow="fullscreen">
                                    </iframe>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No records need review.
            </div>
            {% endif %}
        {% else %}
            {# Approved Records - show grouped by School ‚Üí Grade #}
            <form method="GET" action="{{ url_for('review') }}" class="row g-2 align-items-end mb-3">
                <input type="hidden" name="mode" value="approved">
                <div class="col-md-3">
                    <label class="form-label mb-1"><strong>School</strong></label>
                    <select class="form-select form-select-sm" name="school">
                        <option value="">All schools</option>
                        {% for school in school_filter_options %}
                        <option value="{{ school }}" {% if selected_school_filter == school %}selected{% endif %}>{{ school }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label mb-1"><strong>Grade</strong></label>
                    <select class="form-select form-select-sm" name="grade">
                        <option value="">All grades</option>
                        {% for grade in grade_filter_options %}
                        <option value="{{ grade }}" {% if selected_grade_filter == grade %}selected{% endif %}>{{ grade }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label mb-1"><strong>Batch</strong></label>
                    <select class="form-select form-select-sm" name="batch">
                        <option value="">All batches</option>
                        {% for batch in batch_filter_options %}
                        <option value="{{ batch }}" {% if selected_batch_filter == batch %}selected{% endif %}>{{ batch }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-sm btn-primary w-100">Apply</button>
                    <a href="{{ url_for('review', mode='approved') }}" class="btn btn-sm btn-outline-secondary w-100">Reset</a>
                </div>
            </form>

            <p class="text-muted mb-3">
                Showing <strong>{{ filtered_approved_count }}</strong> approved record(s)
                {% if selected_school_filter or selected_grade_filter or selected_batch_filter %}
                    with active filters.
                {% else %}
                    across all schools, grades, and batches.
                {% endif %}
            </p>

            {% if schools_data %}
            <p class="text-muted mb-3">Records organized by <strong>School ‚Üí Grade</strong></p>
            
            {% for school_name, grades in schools_data.items() %}
            <div class="card mb-3 border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-building"></i> {{ school_name }}
                        <span class="badge bg-light text-dark ms-2">{{ grades|length }} grade(s)</span>
                    </h5>
                    <a href="{{ url_for('export_school_csv', school_name=school_name) }}" 
                       class="btn btn-sm btn-light">
                        <i class="bi bi-download"></i> Export School
                    </a>
                </div>
                <div class="card-body">
                    {% for grade, grade_records in grades.items() %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">
                                <i class="bi bi-mortarboard"></i> Grade {{ grade }}
                                <span class="badge bg-secondary ms-2">{{ grade_records|length }} submission(s)</span>
                            </h6>
                            <a href="{{ url_for('export_grade_csv', school_name=school_name, grade=grade) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download"></i> Export Grade
                            </a>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Father Figure</th>
                                        <th>Word Count</th>
                                        <th>PDF</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in grade_records %}
                                    <tr>
                                        <td class="align-middle">{{ record.student_name or 'N/A' }}</td>
                                        <td class="align-middle">{{ record.father_figure_name or 'N/A' }}</td>
                                        <td class="align-middle">{{ record.word_count or 0 }}</td>
                                        <td class="align-middle">
                                            {% set pdf_path = get_pdf_path(record.get('artifact_dir', '')) %}
                                            {% if pdf_path %}
                                            <a href="{{ url_for('serve_pdf', file_path=pdf_path) }}" 
                                               target="_blank" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-file-pdf"></i> View PDF
                                            </a>
                                            {% else %}
                                            <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="align-middle">
                                            <div class="d-flex flex-wrap gap-1 align-items-center">
                                                <a href="{{ url_for('record_detail', submission_id=record.submission_id) }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-pencil"></i> Edit
                                                </a>
                                                <button class="btn btn-sm btn-outline-warning" 
                                                        onclick="sendForReview('{{ record.submission_id }}')">
                                                    <i class="bi bi-exclamation-triangle"></i> Review
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger px-2" 
                                                        onclick="deleteRecord('{{ record.submission_id }}')"
                                                        title="Delete"
                                                        aria-label="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            {% if approved_ungrouped and approved_ungrouped|length > 0 %}
            <div class="card mb-3 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i> Missing School/Grade
                        <span class="badge bg-dark ms-2">{{ approved_ungrouped|length }} submission(s)</span>
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        These records are marked clean but cannot be grouped by School ‚Üí Grade because school or grade is missing.
                    </p>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>School</th>
                                    <th>Grade</th>
                                    <th>Word Count</th>
                                    <th>PDF</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in approved_ungrouped %}
                                <tr>
                                    <td>{{ record.student_name or 'N/A' }}</td>
                                    <td>{{ record.school_name or 'N/A' }}</td>
                                    <td>{{ record.grade or 'N/A' }}</td>
                                    <td>{{ record.word_count or 0 }}</td>
                                    <td>
                                        {% set pdf_path = get_pdf_path(record.get('artifact_dir', '')) %}
                                        {% if pdf_path %}
                                        <a href="{{ url_for('serve_pdf', file_path=pdf_path) }}" target="_blank" class="btn btn-sm btn-outline-info">
                                            <i class="bi bi-file-pdf"></i> View
                                        </a>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('record_detail', submission_id=record.submission_id) }}" class="btn btn-outline-primary">
                                                <i class="bi bi-pencil"></i> Edit
                                            </a>
                                            <button class="btn btn-outline-warning" onclick="sendForReview('{{ record.submission_id }}')">
                                                <i class="bi bi-exclamation-triangle"></i> Review
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteRecord('{{ record.submission_id }}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No approved records found.
            </div>
            {% endif %}
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Bulk edit functionality
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    const countEl = document.getElementById('selectedCount');
    if (countEl) {
        countEl.textContent = checkboxes.length;
    }
}

function selectAllRecords() {
    document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = true);
    updateSelectedCount();
}

function deselectAllRecords() {
    document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function setBulkDeleteInProgress(inProgress) {
    const buttons = document.querySelectorAll('.bulk-action-btn');
    const checkboxes = document.querySelectorAll('.record-checkbox');
    const loaderEl = document.getElementById('bulkDeleteLoader');
    const cardBody = document.querySelector('.card.border-info .card-body');
    buttons.forEach(btn => { btn.disabled = inProgress; });
    checkboxes.forEach(cb => { cb.disabled = inProgress; });
    if (loaderEl) loaderEl.style.display = inProgress ? 'block' : 'none';
    if (cardBody) cardBody.style.pointerEvents = inProgress ? 'none' : '';
    if (cardBody) cardBody.style.opacity = inProgress ? '0.7' : '1';
}

function bulkDeleteSelected() {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    const statusEl = document.getElementById('bulkEditStatus');

    if (selectedIds.length === 0) {
        showToastModal('Please select at least one record to delete.', 'error');
        return;
    }

    showConfirmModal(
        'Delete Selected Records',
        `Are you sure you want to permanently delete ${selectedIds.length} selected record(s)? This cannot be undone.`,
        'Delete',
        'btn-danger',
        function() {
            setBulkDeleteInProgress(true);
            statusEl.innerHTML = '<span class="text-info"><i class="bi bi-arrow-clockwise spin"></i> Deleting...</span>';
            fetch('/api/bulk_delete_records', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ selected_ids: selectedIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToastModal(data.message, 'success');
                    statusEl.innerHTML = '<span class="text-success">‚úÖ Deleted!</span>';
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToastModal('Error: ' + (data.error || data.message || 'Unknown error'), 'error');
                    statusEl.innerHTML = '<span class="text-danger">‚ùå Error!</span>';
                    setBulkDeleteInProgress(false);
                }
            })
            .catch(error => {
                console.error('Bulk delete error:', error);
                showToastModal('Network error during bulk delete.', 'error');
                statusEl.innerHTML = '<span class="text-danger">‚ùå Network Error!</span>';
                setBulkDeleteInProgress(false);
            });
        }
    );
}

function applyBulkEdit() {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    const bulkSchoolName = document.getElementById('bulk_school_name').value.trim();
    const bulkGrade = document.getElementById('bulk_grade').value.trim();
    const statusEl = document.getElementById('bulkEditStatus');

    if (selectedIds.length === 0) {
        showToastModal('Please select at least one record to update.', 'error');
        return;
    }

    if (!bulkSchoolName && !bulkGrade) {
        showToastModal('Please enter a School Name or Grade to apply.', 'error');
        return;
    }

    showConfirmModal(
        'Apply Bulk Edit',
        `Are you sure you want to update ${selectedIds.length} selected record(s)?`,
        'Apply',
        'btn-primary',
        function() {
            statusEl.innerHTML = '<span class="text-info"><i class="bi bi-arrow-clockwise spin"></i> Applying...</span>';
            fetch('/api/bulk_update_records', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    selected_ids: selectedIds,
                    school_name: bulkSchoolName,
                    grade: bulkGrade
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToastModal(data.message, 'success');
                    statusEl.innerHTML = '<span class="text-success">‚úÖ Applied!</span>';
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToastModal('Error applying bulk edit: ' + (data.error || 'Unknown error'), 'error');
                    statusEl.innerHTML = '<span class="text-danger">‚ùå Error!</span>';
                }
            })
            .catch(error => {
                console.error('Error during bulk update:', error);
                showToastModal('Network error during bulk update.', 'error');
                statusEl.innerHTML = '<span class="text-danger">‚ùå Network Error!</span>';
            });
        }
    );
}

// Initialize selected count on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
});

{% if batch_info and upload_batch_id %}
// Handle batch defaults form submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('batchDefaultsForm');
    const statusEl = document.getElementById('batchDefaultsStatus');
    
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const defaultSchool = document.getElementById('default_school_name').value.trim();
            const defaultGrade = document.getElementById('default_grade').value.trim();
            const defaultTeacher = document.getElementById('default_teacher_name').value.trim();
            
            if (!defaultSchool && !defaultGrade && !defaultTeacher) {
                statusEl.innerHTML = '<span class="text-warning">‚ö†Ô∏è Please enter at least one default value</span>';
                return;
            }
            
            statusEl.innerHTML = '<span class="text-info">‚è≥ Applying defaults...</span>';
            
            fetch(`/api/batches/{{ upload_batch_id }}/apply-defaults`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    default_school_name: defaultSchool || null,
                    default_grade: defaultGrade || null,
                    default_teacher_name: defaultTeacher || null
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = `<span class="text-success">‚úÖ Updated ${data.updated_count} of ${data.total_submissions} submissions</span>`;
                    // Reload page after 1.5 seconds to show updated records
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    statusEl.innerHTML = `<span class="text-danger">‚ùå Error: ${data.error || 'Failed to apply defaults'}</span>`;
                }
            })
            .catch(error => {
                console.error('Error applying defaults:', error);
                statusEl.innerHTML = '<span class="text-danger">‚ùå Network error</span>';
            });
        });
    }
});
{% endif %}

function togglePdfView(submissionId, pdfUrl) {
    const viewer = document.getElementById('pdf-viewer-' + submissionId);
    if (!viewer) {
        console.error('PDF viewer not found for submission:', submissionId);
        return;
    }
    
    if (pdfUrl) {
        // Toggle viewer visibility
        const isHidden = viewer.style.display === 'none' || viewer.style.display === '';
        viewer.style.display = isHidden ? 'block' : 'none';
        
        // Ensure the accordion is expanded so viewer is visible
        const accordionButton = viewer.closest('.accordion-item')?.querySelector('.accordion-button');
        if (accordionButton && accordionButton.classList.contains('collapsed')) {
            accordionButton.click(); // Expand the accordion
        }
        
        // Scroll to viewer when showing
        if (isHidden) {
            setTimeout(() => {
                viewer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);
        }
    } else {
        // Hide viewer
        viewer.style.display = 'none';
    }
}

function approveRecord(submissionId) {
    showConfirmModal(
        'Approve Record',
        'Approve this record and move it to clean batch?',
        'Approve',
        'btn-success',
        function() {
            fetch(`/record/${submissionId}/approve`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToastModal('Record approved successfully!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToastModal('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showToastModal('Error: ' + error.message, 'error');
            });
        }
    );
}

function sendForReview(submissionId) {
    showConfirmModal(
        'Send for Review',
        'Send this record for review?',
        'Send for Review',
        'btn-warning',
        function() {
            fetch(`/record/${submissionId}/send_for_review`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToastModal('Record sent for review!', 'warning');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToastModal('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showToastModal('Error: ' + error.message, 'error');
            });
        }
    );
}

function deleteRecord(submissionId) {
    showConfirmModal(
        'Delete Record',
        '‚ö†Ô∏è Are you sure you want to delete this record? This action cannot be undone.',
        'Delete',
        'btn-danger',
        function() {
            fetch(`/record/${submissionId}/delete`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToastModal('Record deleted successfully!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToastModal('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showToastModal('Error: ' + error.message, 'error');
            });
        }
    );
}

function reprocessRecord(submissionId) {
    showConfirmModal(
        'Reprocess Record',
        'Re-download the original file and run the full pipeline again?',
        'Reprocess',
        'btn-info',
        function() {
            showToastModal('Reprocessing... this may take a few seconds.', 'warning');
            fetch(`/record/${submissionId}/reprocess`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToastModal('Reprocess job enqueued! Refreshing...', 'success');
                    setTimeout(() => location.reload(), 3000);
                } else {
                    showToastModal('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showToastModal('Error: ' + error.message, 'error');
            });
        }
    );
}
</script>
{% endblock %}
