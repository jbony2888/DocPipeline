services:
  # Redis for job queue
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes

  # Main Flask application
  flask-app:
    depends_on:
      - redis
    build:
      context: .
      dockerfile: Dockerfile.flask
    env_file:
      - .env
    ports:
      - "5000:5000"
    volumes:
      # Mount artifacts and outputs for persistence
      - ./artifacts:/app/artifacts
      - ./outputs:/app/outputs
      # Mount data directory for database persistence
      - ./data:/app/data
      # Mount Google Cloud credentials
      # Update this path to point to your own Google Cloud service account JSON file
      - ${GOOGLE_CREDENTIALS_PATH:-./credentials.json}:/app/credentials.json:ro
    environment:
      # Google Cloud Vision credentials (JSON string - preferred method)
      - GOOGLE_CLOUD_VISION_CREDENTIALS_JSON=${GOOGLE_CLOUD_VISION_CREDENTIALS_JSON}
      # Google Cloud Vision credentials (file path - fallback)
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json
      # Groq API key for LLM extraction (FREE and FAST)
      - GROQ_API_KEY=${GROQ_API_KEY}
      # Supabase Authentication
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      # Supabase Service Role Key (required for job enqueueing to bypass RLS)
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      # Flask configuration
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-change-me-in-production}
      - FLASK_PORT=5000
      # Redis connection
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    restart: unless-stopped

  # Background worker for processing submissions
  # Uses Redis/RQ for job queue
  worker:
    depends_on:
      - redis
    build:
      context: .
      dockerfile: Dockerfile.flask
    env_file:
      - .env
    command: python worker_rq.py
    volumes:
      # Mount artifacts and outputs for persistence
      - ./artifacts:/app/artifacts
      - ./outputs:/app/outputs
      # Mount data directory for database persistence
      - ./data:/app/data
      # Mount Google Cloud credentials
      # Update this path to point to your own Google Cloud service account JSON file
      - ${GOOGLE_CREDENTIALS_PATH:-./credentials.json}:/app/credentials.json:ro
    environment:
      # Google Cloud Vision credentials (JSON string - preferred method)
      - GOOGLE_CLOUD_VISION_CREDENTIALS_JSON=${GOOGLE_CLOUD_VISION_CREDENTIALS_JSON}
      # Google Cloud Vision credentials (file path - fallback)
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json
      # Groq API key for LLM extraction (FREE and FAST)
      - GROQ_API_KEY=${GROQ_API_KEY}
      # Supabase Authentication
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      # Supabase Service Role Key (required for worker to bypass RLS)
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      # Worker ID (optional, defaults to worker-<pid>)
      - WORKER_ID=${WORKER_ID:-worker-1}
      # Redis connection
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    restart: unless-stopped

volumes:
  redis_data:

networks:
  default:
    driver: bridge
